name: Gas Report

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'test/**'
      - 'foundry.toml'
  pull_request:
    paths:
      - 'src/**'
      - 'test/**'
      - 'foundry.toml'

jobs:
  gas-report:
    name: Generate Gas Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Generate current gas snapshot
        run: |
          forge snapshot --snap .gas-snapshot-new
          cat .gas-snapshot-new

      - name: Fetch base branch for comparison
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}
          forge snapshot --snap .gas-snapshot-base || echo "No baseline snapshot"
          git checkout -

      - name: Compare gas snapshots (PR)
        if: github.event_name == 'pull_request'
        id: gas-diff
        continue-on-error: true
        run: |
          if [ -f .gas-snapshot-base ]; then
            forge snapshot --diff .gas-snapshot-base .gas-snapshot-new > gas-diff.txt || true
            cat gas-diff.txt
          else
            echo "No baseline to compare"
            echo "has_diff=false" >> $GITHUB_OUTPUT
          fi

          if [ -s gas-diff.txt ]; then
            echo "has_diff=true" >> $GITHUB_OUTPUT
          else
            echo "has_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: Analyze gas changes
        if: github.event_name == 'pull_request' && steps.gas-diff.outputs.has_diff == 'true'
        id: analyze
        run: |
          echo "## Gas Changes" > gas-analysis.txt

          # Parse increases and decreases
          INCREASES=$(grep "^+" gas-diff.txt | wc -l || echo "0")
          DECREASES=$(grep "^-" gas-diff.txt | wc -l || echo "0")

          echo "- Functions with gas increases: $INCREASES" >> gas-analysis.txt
          echo "- Functions with gas decreases: $DECREASES" >> gas-analysis.txt
          echo "" >> gas-analysis.txt

          # Check for large increases (> 5%)
          echo "### Significant Increases (> 5%)" >> gas-analysis.txt

          while IFS= read -r line; do
            # Extract function name and gas values
            if [[ $line =~ ^\+.*\(gas:\ ([0-9]+)\) ]]; then
              NEW_GAS="${BASH_REMATCH[1]}"
              FUNC=$(echo "$line" | sed 's/^+//' | sed 's/ (gas: [0-9]*)//')

              # Get old gas value
              OLD_LINE=$(grep -F "$FUNC" .gas-snapshot-base || echo "")
              if [[ $OLD_LINE =~ \(gas:\ ([0-9]+)\) ]]; then
                OLD_GAS="${BASH_REMATCH[1]}"
                DIFF=$((NEW_GAS - OLD_GAS))
                PERCENT=$((DIFF * 100 / OLD_GAS))

                if [ $PERCENT -gt 5 ]; then
                  echo "- ⚠️ \`$FUNC\`: +${PERCENT}% (+${DIFF} gas)" >> gas-analysis.txt
                  echo "significant_increase=true" >> $GITHUB_OUTPUT
                fi
              fi
            fi
          done < gas-diff.txt

          # Check for large decreases (> 5% - good news!)
          echo "" >> gas-analysis.txt
          echo "### Significant Decreases (> 5%)" >> gas-analysis.txt

          while IFS= read -r line; do
            if [[ $line =~ ^\-.*\(gas:\ ([0-9]+)\) ]]; then
              OLD_GAS="${BASH_REMATCH[1]}"
              FUNC=$(echo "$line" | sed 's/^-//' | sed 's/ (gas: [0-9]*)//')

              # Get new gas value
              NEW_LINE=$(grep -F "$FUNC" .gas-snapshot-new || echo "")
              if [[ $NEW_LINE =~ \(gas:\ ([0-9]+)\) ]]; then
                NEW_GAS="${BASH_REMATCH[1]}"
                DIFF=$((OLD_GAS - NEW_GAS))
                PERCENT=$((DIFF * 100 / OLD_GAS))

                if [ $PERCENT -gt 5 ]; then
                  echo "- ✅ \`$FUNC\`: -${PERCENT}% (-${DIFF} gas)" >> gas-analysis.txt
                fi
              fi
            fi
          done < gas-diff.txt

          cat gas-analysis.txt

      - name: Post gas report to PR
        if: github.event_name == 'pull_request' && steps.gas-diff.outputs.has_diff == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let analysis = '';

            if (fs.existsSync('gas-analysis.txt')) {
              analysis = fs.readFileSync('gas-analysis.txt', 'utf8');
            }

            const diff = fs.readFileSync('gas-diff.txt', 'utf8');

            const body = `## ⛽ Gas Report

${analysis}

<details>
<summary>Full Gas Diff</summary>

\`\`\`diff
${diff}
\`\`\`

</details>

---
*Generated by [Gas Report Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*
`;

            // Find existing gas report comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const gasReportComment = comments.find(comment =>
              comment.body.includes('⛽ Gas Report')
            );

            if (gasReportComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: gasReportComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Warn on significant gas increase
        if: github.event_name == 'pull_request' && steps.analyze.outputs.significant_increase == 'true'
        run: |
          echo "::warning::Significant gas increases detected (> 5%). Please review gas-analysis.txt"

      - name: Check for gas regressions (strict mode)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: |
          # Use forge snapshot --check to fail CI on any gas increase
          # This is strict mode for main branch PRs
          if [ -f .gas-snapshot-base ]; then
            echo "Running strict gas regression check..."

            # Copy base snapshot as reference
            cp .gas-snapshot-base .gas-snapshot

            # Check if new snapshot matches (will fail if any increase)
            if ! forge snapshot --check; then
              echo "::error::Gas regression detected! Some functions use more gas than baseline."
              echo "Review the gas diff above and optimize or document the increase."

              # Only fail if increase is > 10% (configurable threshold)
              if [ "${significant_increase}" = "true" ]; then
                echo "::error::Significant gas regression (> 5%). Failing CI."
                exit 1
              else
                echo "::warning::Minor gas changes detected. Please review."
              fi
            else
              echo "✓ No gas regressions detected"
            fi
          fi

      - name: Upload gas snapshots
        uses: actions/upload-artifact@v4
        with:
          name: gas-snapshots-${{ github.sha }}
          path: |
            .gas-snapshot-new
            .gas-snapshot-base
            gas-diff.txt
            gas-analysis.txt
          retention-days: 30

  gas-benchmark:
    name: Gas Benchmark (Main Branch)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Generate gas snapshot
        run: |
          forge snapshot
          cat .gas-snapshot

      - name: Calculate statistics
        run: |
          echo "## Gas Statistics" > gas-stats.txt
          echo "" >> gas-stats.txt

          # Calculate average, min, max
          TOTAL=0
          COUNT=0
          MIN=999999999
          MAX=0

          while IFS= read -r line; do
            if [[ $line =~ \(gas:\ ([0-9]+)\) ]]; then
              GAS="${BASH_REMATCH[1]}"
              TOTAL=$((TOTAL + GAS))
              COUNT=$((COUNT + 1))

              if [ $GAS -lt $MIN ]; then
                MIN=$GAS
              fi
              if [ $GAS -gt $MAX ]; then
                MAX=$GAS
              fi
            fi
          done < .gas-snapshot

          if [ $COUNT -gt 0 ]; then
            AVG=$((TOTAL / COUNT))

            echo "- Total tests: $COUNT" >> gas-stats.txt
            echo "- Average gas: $(printf "%'d" $AVG)" >> gas-stats.txt
            echo "- Min gas: $(printf "%'d" $MIN)" >> gas-stats.txt
            echo "- Max gas: $(printf "%'d" $MAX)" >> gas-stats.txt
            echo "- Total gas: $(printf "%'d" $TOTAL)" >> gas-stats.txt
          fi

          cat gas-stats.txt

      - name: Commit gas snapshot to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain .gas-snapshot)" ]; then
            git add .gas-snapshot
            git commit -m "chore: update gas snapshot [skip ci]"
            git push
          else
            echo "No changes to gas snapshot"
          fi

      - name: Upload benchmark
        uses: actions/upload-artifact@v4
        with:
          name: gas-benchmark-${{ github.run_number }}
          path: |
            .gas-snapshot
            gas-stats.txt
          retention-days: 90
