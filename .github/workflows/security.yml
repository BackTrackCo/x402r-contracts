name: Security Analysis

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'slither.config.json'
  pull_request:
    paths:
      - 'src/**'
      - 'lib/**'
      - 'slither.config.json'
  schedule:
    # Weekly security scan on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Slither
        run: |
          pip3 install slither-analyzer
          slither --version

      - name: Run Slither
        id: slither
        continue-on-error: true
        run: |
          slither . \
            --config-file slither.config.json \
            --sarif slither-results.sarif \
            --json slither-report.json \
            2>&1 | tee slither-output.txt

      - name: Analyze Slither results
        id: analyze
        run: |
          echo "## Slither Analysis Results" > slither-summary.txt

          if [ -f slither-report.json ]; then
            # Count findings by severity
            HIGH=$(jq '[.results.detectors[] | select(.impact == "High")] | length' slither-report.json || echo "0")
            MEDIUM=$(jq '[.results.detectors[] | select(.impact == "Medium")] | length' slither-report.json || echo "0")
            LOW=$(jq '[.results.detectors[] | select(.impact == "Low")] | length' slither-report.json || echo "0")
            INFO=$(jq '[.results.detectors[] | select(.impact == "Informational")] | length' slither-report.json || echo "0")

            echo "- üî¥ High: $HIGH" >> slither-summary.txt
            echo "- üü† Medium: $MEDIUM" >> slither-summary.txt
            echo "- üü° Low: $LOW" >> slither-summary.txt
            echo "- ‚ÑπÔ∏è Informational: $INFO" >> slither-summary.txt

            # Set outputs
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT

            # Fail if high severity issues found
            if [ "$HIGH" -gt 0 ]; then
              echo "critical=true" >> $GITHUB_OUTPUT
              echo "" >> slither-summary.txt
              echo "### ‚ö†Ô∏è Critical Issues Found" >> slither-summary.txt
              jq -r '.results.detectors[] | select(.impact == "High") | "- \(.check): \(.description)"' slither-report.json >> slither-summary.txt
            fi
          else
            echo "No Slither report generated" >> slither-summary.txt
          fi

          cat slither-summary.txt

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: slither-results.sarif
          category: slither

      - name: Upload Slither reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slither-reports-${{ github.sha }}
          path: |
            slither-output.txt
            slither-report.json
            slither-results.sarif
            slither-summary.txt
          retention-days: 30

      - name: Post Slither results to PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let summary = 'Slither analysis completed.';

            if (fs.existsSync('slither-summary.txt')) {
              summary = fs.readFileSync('slither-summary.txt', 'utf8');
            }

            const body = `## üîç Slither Security Analysis

${summary}

<details>
<summary>View Full Report</summary>

View the detailed report in [GitHub Security](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/security/code-scanning) or download the artifacts.

</details>

---
*Generated by [Security Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*
`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const slitherComment = comments.find(comment =>
              comment.body.includes('üîç Slither Security Analysis')
            );

            if (slitherComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: slitherComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail on high severity issues
        if: steps.analyze.outputs.critical == 'true'
        run: |
          echo "::error::High severity security issues detected"
          exit 1

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run tests with coverage
        run: |
          forge coverage --report lcov

      - name: Generate coverage report
        run: |
          sudo apt-get install -y lcov
          lcov --list coverage.lcov > coverage-summary.txt
          cat coverage-summary.txt

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.sha }}
          path: |
            coverage.lcov
            coverage-summary.txt
          retention-days: 30

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Check Solady version
        run: |
          cd lib/solady
          SOLADY_COMMIT=$(git rev-parse HEAD)
          SOLADY_DATE=$(git log -1 --format=%ci)
          echo "Solady commit: $SOLADY_COMMIT"
          echo "Solady date: $SOLADY_DATE"

          # Check if older than 6 months
          AGE_DAYS=$(( ($(date +%s) - $(date -d "$SOLADY_DATE" +%s)) / 86400 ))
          echo "Age: $AGE_DAYS days"

          if [ $AGE_DAYS -gt 180 ]; then
            echo "::warning::Solady is older than 6 months. Consider updating."
          fi

      - name: Check OpenZeppelin version
        run: |
          cd lib/openzeppelin-contracts
          OZ_COMMIT=$(git rev-parse HEAD)
          OZ_DATE=$(git log -1 --format=%ci)
          echo "OpenZeppelin commit: $OZ_COMMIT"
          echo "OpenZeppelin date: $OZ_DATE"

          AGE_DAYS=$(( ($(date +%s) - $(date -d "$OZ_DATE" +%s)) / 86400 ))
          echo "Age: $AGE_DAYS days"

          if [ $AGE_DAYS -gt 180 ]; then
            echo "::warning::OpenZeppelin is older than 6 months. Consider updating."
          fi

      - name: Check for known vulnerabilities
        run: |
          echo "Checking for known security advisories..."

          # Check Solady GitHub Security Advisories
          echo "Solady advisories: https://github.com/Vectorized/solady/security/advisories"

          # Check OpenZeppelin GitHub Security Advisories
          echo "OpenZeppelin advisories: https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories"

          echo "No automated check available. Manual review required."

  comprehensive-security-check:
    name: Comprehensive Security Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip3 install slither-analyzer
          pip3 install crytic-compile

      - name: Run comprehensive Slither checks
        run: |
          echo "## Comprehensive Security Analysis" > comprehensive-report.txt
          echo "" >> comprehensive-report.txt

          # Human summary
          echo "### Contract Summary" >> comprehensive-report.txt
          slither . --print human-summary >> comprehensive-report.txt 2>&1 || true

          # Contract summary
          echo "" >> comprehensive-report.txt
          echo "### Function Summary" >> comprehensive-report.txt
          slither . --print contract-summary >> comprehensive-report.txt 2>&1 || true

          # Variables and authorization
          echo "" >> comprehensive-report.txt
          echo "### Variables and Authorization" >> comprehensive-report.txt
          slither . --print vars-and-auth >> comprehensive-report.txt 2>&1 || true

          cat comprehensive-report.txt

      - name: Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-${{ github.run_number }}
          path: comprehensive-report.txt
          retention-days: 90

      - name: Create security issue if needed
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Weekly Security Scan Detected Issues - ${new Date().toISOString().split('T')[0]}`,
              body: `The weekly comprehensive security scan has detected potential issues.\n\nWorkflow: ${context.workflow}\nRun: ${context.runNumber}\n\nPlease review the security reports in the workflow artifacts.`,
              labels: ['security', 'needs-review']
            });
